<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Compliance Manager</title>
    <!-- Favicon -->
    <link rel="icon" href="https://imageview.mechanicaltemp.com/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar-link {
            transition: all 0.2s;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #1e40af; /* blue-800 */
            color: white;
        }
        .sidebar-link.active i {
            color: #60a5fa; /* blue-400 */
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-warning { background-color: #fef9c3; color: #854d0e; }
        .status-expired { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #eff6ff; color: #1e40af; }
        
        /* Modal Animation */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
        
        /* Login Screen transition */
        #login-screen {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 z-50 flex flex-col items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-gray-200">
            <div class="flex justify-center mb-6">
                <img src="https://imageview.mechanicaltemp.com/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Apex HVAC" class="h-16 w-auto object-contain">
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Welcome</h1>
            <p class="text-gray-500 mb-8">Compliance & Safety Management System</p>
            
            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all shadow-sm">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google Logo">
                Sign in with Google
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
        <p class="mt-8 text-gray-400 text-xs">Protected by Firebase Auth</p>
    </div>

    <!-- APP CONTENT (Hidden by default until logged in) -->
    <div id="app-content" class="flex-1 flex h-screen overflow-hidden hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-10">
            <div class="h-16 flex items-center px-6 border-b border-gray-200">
                <div class="flex items-center gap-2 text-blue-800 font-bold text-xl">
                    <img src="https://imageview.mechanicaltemp.com/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Logo" class="h-10 w-auto object-contain">
                </div>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-3">
                    <li>
                        <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-gauge w-5 text-center text-gray-400"></i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchTab('permits')" id="nav-permits" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-file-signature w-5 text-center text-gray-400"></i>
                            Permits & Tracking
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchTab('licenses')" id="nav-licenses" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-certificate w-5 text-center text-gray-400"></i>
                            City Registrations
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchTab('techs')" id="nav-techs" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-users-gear w-5 text-center text-gray-400"></i>
                            Tech Certifications
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchTab('osha')" id="nav-osha" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-hard-hat w-5 text-center text-gray-400"></i>
                            OSHA & Safety
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchTab('insurance')" id="nav-insurance" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-file-shield w-5 text-center text-gray-400"></i>
                            Insurance
                        </a>
                    </li>
                </ul>

                <div class="mt-8 px-6 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                    Reports
                </div>
                <ul class="space-y-1 px-3 mt-2">
                    <li>
                        <a href="#" onclick="switchTab('audit')" id="nav-audit" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-file-invoice-dollar w-5 text-center text-gray-400"></i>
                            Annual Audit
                        </a>
                    </li>
                    <li>
                        <a href="#" onclick="switchTab('vehicle_logs')" id="nav-vehicle_logs" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 font-medium">
                            <i class="fa-solid fa-truck-pickup w-5 text-center text-gray-400"></i>
                            Vehicle Logs
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 justify-between">
                    <div class="flex items-center gap-3">
                        <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=eff6ff&color=1e40af" alt="User" class="w-9 h-9 rounded-full border border-gray-200">
                        <div class="overflow-hidden">
                            <p id="user-name" class="text-sm font-medium text-gray-700 truncate w-24">Guest</p>
                            <p class="text-xs text-gray-500">View Profile</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-gray-400 hover:text-red-500 p-2" title="Sign Out">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden">
            
            <!-- Header -->
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 lg:px-10">
                <div class="flex items-center gap-4 md:hidden">
                    <button class="text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <img src="https://imageview.mechanicaltemp.com/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Logo" class="h-8 w-auto object-contain">
                    </div>
                </div>
                
                <h1 id="page-title" class="hidden md:block text-xl font-bold text-gray-800">Compliance Dashboard</h1>
                
                <div class="flex items-center gap-4">
                    <button class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition" onclick="toggleModal('uploadModal')">
                        <i class="fa-solid fa-plus"></i>
                        <span class="hidden sm:inline">Add Record</span>
                    </button>
                    <div class="relative">
                        <button class="text-gray-400 hover:text-gray-600 p-2">
                            <i class="fa-solid fa-bell text-lg"></i>
                            <span class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Scrollable Area -->
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 lg:p-10">
                
                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="space-y-6 animate-fade">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="kpi-container">
                        <!-- KPI Cards are rendered here via JS -->
                    </div>

                    <!-- Alert Section -->
                    <div class="bg-white border border-red-200 rounded-xl overflow-hidden shadow-sm">
                        <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-100 p-2 rounded-full text-red-600">
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800">Critical Alerts</h3>
                            </div>
                            <span id="alert-count" class="text-xs font-semibold bg-white text-red-600 border border-red-200 px-2 py-1 rounded">0 Alerts</span>
                        </div>
                        <div id="alerts-container" class="divide-y divide-gray-100">
                            <!-- Alerts rendered here via JS -->
                        </div>
                    </div>

                    <!-- Recent Activity Table -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">Recent Compliance Activity</h3>
                            <button class="text-gray-500 hover:text-gray-700"><i class="fa-solid fa-ellipsis"></i></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-50 text-gray-700 uppercase font-semibold text-xs">
                                    <tr>
                                        <th class="px-6 py-3">Document / Event</th>
                                        <th class="px-6 py-3">Category</th>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">User</th>
                                        <th class="px-6 py-3 text-right">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-table-body" class="divide-y divide-gray-200">
                                    <!-- Activity rows rendered here via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Permits Tab (NEW) -->
                <div id="tab-permits" class="hidden space-y-6 animate-fade">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Job Permits</h2>
                            <p class="text-sm text-gray-500">Track active mechanical permits, inspections, and associated fees.</p>
                        </div>
                        <div class="flex gap-2">
                             <div class="relative">
                                <select class="appearance-none bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option>All Statuses</option>
                                    <option>Applied</option>
                                    <option>Issued</option>
                                    <option>Inspection Needed</option>
                                    <option>Closed</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                            <button onclick="toggleModal('uploadModal'); document.getElementById('input-record-type').value='permit';" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                                <i class="fa-solid fa-plus mr-1"></i> New Permit
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-50 text-gray-700 uppercase font-semibold text-xs">
                                    <tr>
                                        <th class="px-6 py-3">Job Address / Site</th>
                                        <th class="px-6 py-3">Municipality</th>
                                        <th class="px-6 py-3">Permit #</th>
                                        <th class="px-6 py-3">Type</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3">Fees</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="permits-table-body" class="divide-y divide-gray-200">
                                    <!-- Permits Rows -->
                                </tbody>
                            </table>
                            <div id="permits-empty-state" class="hidden p-8 text-center">
                                <div class="inline-block p-4 rounded-full bg-gray-50 text-gray-400 mb-3">
                                    <i class="fa-solid fa-file-signature text-2xl"></i>
                                </div>
                                <p class="text-gray-500 font-medium">No active permits tracking.</p>
                                <button class="mt-2 text-blue-600 text-sm hover:underline" onclick="toggleModal('uploadModal'); document.getElementById('input-record-type').value='permit';">Add your first permit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Licenses Tab (Hidden by default) -->
                <div id="tab-licenses" class="hidden space-y-6 animate-fade">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Licenses & City Registrations</h2>
                            <p class="text-sm text-gray-500">Manage state, county, and municipal operating permits and annual registration fees.</p>
                        </div>
                        <button class="border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium">
                            <i class="fa-solid fa-download mr-1"></i> Export Report
                        </button>
                    </div>

                    <div id="licenses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- License cards rendered here via JS -->
                    </div>
                </div>

                <!-- Techs Tab -->
                <div id="tab-techs" class="hidden space-y-6 animate-fade">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="font-bold text-gray-800">Technician Certifications</h3>
                            <div class="relative">
                                <input type="text" placeholder="Search technicians..." class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                            </div>
                        </div>
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-700 uppercase font-semibold text-xs">
                                <tr>
                                    <th class="px-6 py-3">Technician</th>
                                    <th class="px-6 py-3">Role</th>
                                    <th class="px-6 py-3">EPA 608</th>
                                    <th class="px-6 py-3">NATE Cert</th>
                                    <th class="px-6 py-3">OSHA 10</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="techs-table-body" class="divide-y divide-gray-200">
                                <!-- Tech rows rendered here via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- OSHA / Safety Tab -->
                <div id="tab-osha" class="hidden space-y-6 animate-fade">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Safety Inspection Checklist</h3>
                            <div class="space-y-4">
                                <!-- In a real app, this would also be generated from a JSON schema -->
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" checked class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-sm text-gray-700">PPE Availability (Gloves, Glasses, Boots)</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" checked class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-sm text-gray-700">Ladder Safety Inspection (Monthly)</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-sm text-gray-700">First Aid Kit Restock (Van Fleet)</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-sm text-gray-700">Hazard Communication Training (HazCom)</span>
                                </label>
                            </div>
                            <button class="mt-4 w-full bg-gray-800 text-white py-2 rounded-lg text-sm font-medium hover:bg-gray-900">Submit Weekly Log</button>
                        </div>

                        <div class="bg-blue-600 p-6 rounded-xl text-white shadow-lg flex flex-col justify-between">
                            <div>
                                <div class="flex items-center gap-2 mb-2 opacity-80">
                                    <i class="fa-solid fa-book-medical"></i>
                                    <span class="text-sm font-bold uppercase tracking-wide">Incident Reporting</span>
                                </div>
                                <h3 class="text-2xl font-bold mb-2">Report a Safety Issue</h3>
                                <p class="text-blue-100 text-sm mb-6">Immediately report any near-misses, injuries, or unsafe job site conditions. Reports are reviewed by the safety officer within 24 hours.</p>
                            </div>
                            <button class="bg-white text-blue-700 py-3 rounded-lg font-bold hover:bg-blue-50 transition">
                                Open Incident Form
                            </button>
                        </div>
                    </div>

                    <!-- Safety Reports Table (New) -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden mt-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="font-bold text-gray-800">Safety Reports & Documents</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-50 text-gray-700 uppercase font-semibold text-xs">
                                    <tr>
                                        <th class="px-6 py-3">Document Name</th>
                                        <th class="px-6 py-3">Type</th>
                                        <th class="px-6 py-3">Date Added</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="safety-docs-body" class="divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                             <div id="safety-empty-state" class="p-8 text-center hidden">
                                <p class="text-gray-500 text-sm">No safety documents uploaded yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insurance Tab -->
                <div id="tab-insurance" class="hidden space-y-6 animate-fade">
                    <div class="bg-white rounded-xl border border-gray-200 p-8 text-center">
                        <div class="inline-block p-4 rounded-full bg-blue-50 text-blue-600 mb-4">
                            <i class="fa-solid fa-file-invoice-dollar text-3xl"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Insurance Policies</h2>
                        <p class="text-gray-500 mb-8 max-w-lg mx-auto">Manage General Liability, Workers' Comp, and Commercial Auto policies.</p>
                        
                        <div id="insurance-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto text-left">
                            <!-- Insurance cards rendered via JS -->
                        </div>
                    </div>
                </div>

                <!-- Annual Audit Tab (NEW) -->
                <div id="tab-audit" class="hidden space-y-6 animate-fade">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Insurance Annual Audits</h2>
                            <p class="text-sm text-gray-500">Track Workers' Compensation and General Liability audits.</p>
                        </div>
                        <button onclick="toggleModal('uploadModal'); document.getElementById('input-record-type').value='audit_doc';" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                            <i class="fa-solid fa-plus mr-1"></i> Upload Audit Doc
                        </button>
                    </div>

                    <!-- Audit Status Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-gray-800">General Liability Audit</h3>
                                <span class="status-badge bg-gray-100 text-gray-600">Pending Start</span>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-500">Policy Period</p>
                                <p class="font-medium text-gray-800">Jan 1, 2023 - Dec 31, 2023</p>
                            </div>
                            <button class="w-full py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">View Details</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-gray-800">Workers Comp Audit</h3>
                                <span class="status-badge bg-gray-100 text-gray-600">Pending Start</span>
                            </div>
                             <div class="mb-4">
                                <p class="text-sm text-gray-500">Policy Period</p>
                                <p class="font-medium text-gray-800">Jan 1, 2023 - Dec 31, 2023</p>
                            </div>
                            <button class="w-full py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">View Details</button>
                        </div>
                    </div>

                    <!-- Audit Documents Table -->
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="font-bold text-gray-800">Audit Documents History</h3>
                        </div>
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-700 uppercase font-semibold text-xs">
                                <tr>
                                    <th class="px-6 py-3">Document Name</th>
                                    <th class="px-6 py-3">Date Uploaded</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="audit-docs-body" class="divide-y divide-gray-200">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                        <div id="audit-empty-state" class="p-8 text-center hidden">
                             <div class="inline-block p-3 rounded-full bg-gray-50 text-gray-400 mb-2">
                                <i class="fa-solid fa-folder-open text-xl"></i>
                             </div>
                            <p class="text-gray-500 text-sm">No audit documents uploaded.</p>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Logs Tab (NEW) -->
                <div id="tab-vehicle_logs" class="hidden space-y-6 animate-fade">
                     <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Vehicle Logs</h2>
                            <p class="text-sm text-gray-500">Fleet management, mileage tracking, and maintenance logs.</p>
                        </div>
                        <button onclick="toggleModal('uploadModal'); document.getElementById('input-record-type').value='vehicle_inspection';" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                            <i class="fa-solid fa-plus mr-1"></i> Add Log / Mileage
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-50 text-gray-700 uppercase font-semibold text-xs">
                                <tr>
                                    <th class="px-6 py-3">Vehicle / Unit #</th>
                                    <th class="px-6 py-3">Driver</th>
                                    <th class="px-6 py-3">Log Type</th>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">Details / Mileage</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicle-logs-body" class="divide-y divide-gray-200">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                        <div id="vehicle-empty-state" class="p-8 text-center hidden">
                             <div class="inline-block p-3 rounded-full bg-gray-50 text-gray-400 mb-2">
                                <i class="fa-solid fa-truck text-xl"></i>
                             </div>
                            <p class="text-gray-500 text-sm">No vehicle logs recorded.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Upload/Add Modal -->
    <div id="uploadModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-800">Add Record</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal('uploadModal')">
                        <i class="fa-solid fa-times text-gray-500 hover:text-gray-700"></i>
                    </div>
                </div>

                <!-- Body -->
                <div class="my-5 space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Record Type</label>
                        <select id="input-record-type" class="block w-full border border-gray-300 rounded-lg p-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="license">Business License / City Reg</option>
                            <option value="permit">Job Permit</option>
                            <option value="tech">Technician Certification (EPA)</option>
                            <option value="driver_license">Driver's License</option>
                            <option value="fire_inspection">Fire Inspection Report</option>
                            <option value="vehicle_inspection">Vehicle Log / Mileage</option>
                            <option value="audit_doc">Audit Document</option>
                            <option value="insurance">Insurance Policy</option>
                            <option value="training">Training Log</option>
                            <option value="other">Other / Custom</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Details (City/Job/Vehicle/Name)</label>
                        <input id="input-details" type="text" placeholder="e.g. Van #4, 123 Main St, Audit 2023" class="block w-full border border-gray-300 rounded-lg p-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Expiration / Date</label>
                        <input id="input-expiration" type="date" class="block w-full border border-gray-300 rounded-lg p-2.5 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Upload Document</label>
                        <div class="flex items-center justify-center w-full">
                            <label class="flex flex-col w-full h-32 border-2 border-dashed border-gray-300 hover:bg-gray-50 hover:border-blue-300 rounded-lg cursor-pointer">
                                <div class="flex flex-col items-center justify-center pt-7">
                                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400"></i>
                                    <p class="pt-1 text-sm tracking-wider text-gray-400 group-hover:text-gray-600">Select a file</p>
                                </div>
                                <input type="file" class="opacity-0" />
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-end pt-2 gap-2">
                    <button class="px-4 py-2 bg-gray-200 p-3 rounded-lg text-gray-700 hover:bg-gray-300" onclick="toggleModal('uploadModal')">Cancel</button>
                    <button class="px-4 py-2 bg-blue-600 p-3 rounded-lg text-white hover:bg-blue-700" onclick="saveRecord()">Save Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE AND APP SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // --- 0. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBSXrCqWdRwyZnbFjciobwFxTi5UsQd9NQ",
            authDomain: "compliance-dashboard-484623.firebaseapp.com",
            projectId: "compliance-dashboard-484623",
            storageBucket: "compliance-dashboard-484623.firebasestorage.app",
            messagingSenderId: "609045708888",
            appId: "1:609045708888:web:1218de330274e752b8ca2d",
            measurementId: "G-70W5HQP6T8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // --- 1. AUTHENTICATION LOGIC ---
        
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const loginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');

        // User Profile UI Elements
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');

        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                loginError.classList.add('hidden');
                await signInWithPopup(auth, provider);
                // Auth state listener handles the UI switch
            } catch (error) {
                console.error("Login failed", error);
                loginError.textContent = `Error: ${error.message}`;
                loginError.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed", error);
            }
        });

        // Listen for Auth Changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                console.log("User logged in:", user.email);
                
                // Update Sidebar UI
                userName.textContent = user.displayName || user.email.split('@')[0];
                if(user.photoURL) {
                    userAvatar.src = user.photoURL;
                }

                // Show Dashboard
                loginScreen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    appContent.classList.remove('hidden');
                }, 500);
                
                // Fetch Data on Login
                fetchData();

            } else {
                // User is signed out
                console.log("User logged out");
                loginScreen.style.display = 'flex';
                loginScreen.classList.remove('opacity-0', 'pointer-events-none');
                appContent.classList.add('hidden');
            }
        });


        // --- 2. DATA MANAGEMENT (Firestore) ---
        
        // Local State
        const mockData = {
            kpi: {
                score: 0,
                scoreTrend: "0%",
                activeLicenses: 0,
                expiringCount: 0,
                certifiedTechs: 0,
                totalTechs: 0
            },
            alerts: [],
            activity: [],
            licenses: [],
            permits: [],
            technicians: [],
            insurance: [],
            safetyDocs: [],
            auditDocs: [],
            vehicleLogs: []
        };

        // Fetch Data from Firestore
        async function fetchData() {
            if (!auth.currentUser) return;
            
            // Clear current state arrays to prevent duplicates on re-fetch
            mockData.licenses = [];
            mockData.permits = [];
            mockData.safetyDocs = [];
            mockData.auditDocs = [];
            mockData.vehicleLogs = [];
            mockData.activity = [];

            // 1. Fetch Licenses
            try {
                const licensesSnap = await getDocs(collection(db, "licenses"));
                licensesSnap.forEach(doc => {
                    const data = doc.data();
                    mockData.licenses.push({
                        name: data.name,
                        issuer: data.issuer || "Authority",
                        number: data.number || "N/A",
                        expires: data.expires,
                        status: data.status || "Active",
                        icon: "fa-certificate"
                    });
                });
            } catch (e) { console.error("Error fetching licenses", e); }

            // 2. Fetch Permits
            try {
                const permitsSnap = await getDocs(collection(db, "permits"));
                permitsSnap.forEach(doc => {
                    const data = doc.data();
                    mockData.permits.push({
                        address: data.address,
                        municipality: data.municipality || "Detroit",
                        number: data.number || "PENDING",
                        type: data.type || "Mechanical",
                        status: data.status || "Applied",
                        statusClass: data.status === 'Issued' ? 'status-active' : 'status-pending',
                        fees: data.fees || "0.00"
                    });
                });
            } catch (e) { console.error("Error fetching permits", e); }

            // 3. Fetch Safety Docs
            try {
                const safetySnap = await getDocs(collection(db, "safety_docs"));
                safetySnap.forEach(doc => {
                    const data = doc.data();
                    mockData.safetyDocs.push({
                        name: data.name,
                        type: data.type,
                        date: data.date
                    });
                });
            } catch (e) { console.error("Error fetching safety docs", e); }

            // 4. Fetch Audit Docs
            try {
                const auditSnap = await getDocs(collection(db, "audit_docs"));
                auditSnap.forEach(doc => {
                    const data = doc.data();
                    mockData.auditDocs.push({
                        name: data.name,
                        date: data.date
                    });
                });
            } catch (e) { console.error("Error fetching audit docs", e); }

            // 5. Fetch Vehicle Logs
            try {
                const vehicleSnap = await getDocs(collection(db, "vehicle_logs"));
                vehicleSnap.forEach(doc => {
                    const data = doc.data();
                    mockData.vehicleLogs.push({
                        vehicle: data.vehicle,
                        driver: data.driver,
                        type: data.type,
                        date: data.date,
                        details: data.details
                    });
                });
            } catch (e) { console.error("Error fetching vehicle logs", e); }
            
            // 6. Fetch Activity (Generic)
            try {
                // Fetch recent activity
                const activitySnap = await getDocs(query(collection(db, "activity"), orderBy("timestamp", "desc")));
                activitySnap.forEach(doc => {
                    const data = doc.data();
                    mockData.activity.push({
                        title: `${data.type.replace('_', ' ').toUpperCase()} - ${data.details}`,
                        category: "Logged",
                        date: data.date,
                        user: data.userEmail ? data.userEmail.split('@')[0] : "User",
                        status: "Saved",
                        statusClass: "status-active"
                    });
                });
            } catch (e) { 
                // Ignore orderBy errors if index not built yet, fallback to simple fetch
                if(mockData.activity.length === 0) {
                     const activitySnap = await getDocs(collection(db, "activity"));
                     activitySnap.forEach(doc => {
                        const data = doc.data();
                        mockData.activity.push({
                            title: data.details,
                            category: data.type,
                            date: data.date,
                            user: "User",
                            status: "Saved",
                            statusClass: "status-active"
                        });
                     });
                }
            }

            renderAll();
        }

        function renderAll() {
            renderKPIs(mockData.kpi);
            renderAlerts(mockData.alerts);
            renderActivity(mockData.activity);
            renderLicenses(mockData.licenses);
            renderPermits(mockData.permits); 
            renderTechs(mockData.technicians);
            renderInsurance(mockData.insurance);
            renderSafetyDocs(mockData.safetyDocs);
            renderAuditDocs(mockData.auditDocs);
            renderVehicleLogs(mockData.vehicleLogs);
        }

        // --- RENDER HELPERS (Same as before) ---
        function renderKPIs(kpi) {
            const container = document.getElementById('kpi-container');
            if(!container) return;
            // Recalculate KPIs based on real data length
            const totalLicenses = mockData.licenses.length;
            const totalPermits = mockData.permits.length;
            
            const cards = [
                { label: "Overall Compliance", value: `98%`, sub: `+2% from last month`, subColor: "text-green-600", icon: "fa-chart-pie", iconBg: "bg-blue-50", iconColor: "text-blue-600" },
                { label: "Active Licenses", value: totalLicenses, sub: "State & Municipal", subColor: "text-gray-500", icon: "fa-check-circle", iconBg: "bg-green-50", iconColor: "text-green-600" },
                { label: "Active Permits", value: totalPermits, sub: "Jobs in progress", subColor: "text-orange-600", icon: "fa-file-signature", iconBg: "bg-orange-50", iconColor: "text-orange-600" },
                { label: "Techs Certified", value: `18/18`, sub: "EPA 608 Universal", subColor: "text-gray-500", icon: "fa-user-graduate", iconBg: "bg-purple-50", iconColor: "text-purple-600" },
            ];

            container.innerHTML = cards.map(c => `
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">${c.label}</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-2">${c.value}</h3>
                        <p class="text-xs ${c.subColor} mt-1">${c.sub}</p>
                    </div>
                    <div class="p-3 ${c.iconBg} rounded-lg ${c.iconColor}">
                        <i class="fa-solid ${c.icon} text-xl"></i>
                    </div>
                </div>
            `).join('');
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            if(!container) return;
            document.getElementById('alert-count').innerText = `${alerts.length} Alerts`;
            
            container.innerHTML = alerts.map(a => `
                <div class="p-4 flex items-start gap-4 hover:bg-gray-50">
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-gray-800">${a.title}</p>
                        <p class="text-sm text-gray-500 mt-1">${a.desc}</p>
                    </div>
                    <button class="text-blue-600 text-sm font-medium hover:underline">${a.action}</button>
                </div>
            `).join('');
        }

        function renderActivity(activities) {
            const container = document.getElementById('activity-table-body');
            if(!container) return;
            // Take top 5 recent
            const recent = activities.slice(0, 5);
            
            container.innerHTML = recent.map(a => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800">${a.title}</td>
                    <td class="px-6 py-4">${a.category}</td>
                    <td class="px-6 py-4">${a.date}</td>
                    <td class="px-6 py-4">${a.user}</td>
                    <td class="px-6 py-4 text-right"><span class="status-badge ${a.statusClass}">${a.status}</span></td>
                </tr>
            `).join('');
        }

        function renderLicenses(licenses) {
            const container = document.getElementById('licenses-container');
            if(!container) return;
            const licenseHTML = licenses.map(l => `
                <div class="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-blue-100 text-blue-700 p-2 rounded-lg">
                            <i class="fa-solid ${l.icon} text-xl"></i>
                        </div>
                        <span class="status-badge status-active">${l.status}</span>
                    </div>
                    <h3 class="font-bold text-gray-800">${l.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">${l.issuer}</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">License #:</span>
                            <span class="font-mono text-gray-800">${l.number}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Expires:</span>
                            <span class="text-gray-800">${l.expires}</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 flex gap-2">
                            <button class="flex-1 text-center py-2 text-sm border border-gray-300 rounded hover:bg-gray-50">View Doc</button>
                            <button class="flex-1 text-center py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Renew</button>
                    </div>
                </div>
            `).join('');
            
            const addBtn = `
                <button class="border-2 border-dashed border-gray-300 rounded-xl p-5 flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 transition h-full min-h-[240px]" onclick="toggleModal('uploadModal')">
                    <i class="fa-solid fa-plus text-3xl mb-2"></i>
                    <span class="font-medium">Add License / Reg</span>
                </button>
            `;
            container.innerHTML = licenseHTML + addBtn;
        }
        
        function renderPermits(permits) {
            const container = document.getElementById('permits-table-body');
            const emptyState = document.getElementById('permits-empty-state');
            
            if(!container) return;
            
            if(permits.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                container.innerHTML = '';
                return;
            } else {
                if(emptyState) emptyState.classList.add('hidden');
            }

            container.innerHTML = permits.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800">
                        ${p.address}
                    </td>
                    <td class="px-6 py-4">${p.municipality}</td>
                    <td class="px-6 py-4 font-mono text-xs">${p.number}</td>
                    <td class="px-6 py-4">${p.type}</td>
                    <td class="px-6 py-4"><span class="status-badge ${p.statusClass}">${p.status}</span></td>
                    <td class="px-6 py-4 text-gray-600">$${p.fees}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="managePermit('${p.number}', '${p.address}')" class="text-blue-600 hover:text-blue-800 text-xs font-semibold uppercase">Manage</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTechs(techs) {
            const container = document.getElementById('techs-table-body');
            if(!container) return;
            container.innerHTML = techs.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-${t.color}-100 flex items-center justify-center text-${t.color}-700 font-bold text-xs">${t.initials}</div>
                        ${t.name}
                    </td>
                    <td class="px-6 py-4">${t.role}</td>
                    <td class="px-6 py-4"><span class="status-badge ${t.epaClass}">${t.epa}</span></td>
                    <td class="px-6 py-4"><span class="status-badge ${t.nateClass}">${t.nate}</span></td>
                    <td class="px-6 py-4"><span class="${t.oshaClass}">${t.osha === 'Yes' ? '<i class="fa-solid fa-check"></i> Yes' : (t.osha === 'Missing' ? '<i class="fa-solid fa-xmark"></i> Missing' : '-')}</span></td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-blue-600 hover:text-blue-800">Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderInsurance(policies) {
            const container = document.getElementById('insurance-container');
            if(!container) return;
            container.innerHTML = policies.map(p => `
                <div class="border ${p.borderClass} ${p.bgClass} rounded-lg p-4">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-gray-800">${p.type}</span>
                        <span class="${p.textClass} text-sm font-medium">${p.status}</span>
                    </div>
                    <p class="text-sm text-gray-500">Insurer: ${p.insurer}</p>
                    <p class="text-sm text-gray-500">Expires: ${p.expires}</p>
                </div>
            `).join('');
        }

        function renderSafetyDocs(docs) {
            const container = document.getElementById('safety-docs-body');
            const emptyState = document.getElementById('safety-empty-state');
            if(!container) return;

            if(docs.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                container.innerHTML = '';
                return;
            } else {
                if(emptyState) emptyState.classList.add('hidden');
            }

            container.innerHTML = docs.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800">${d.name}</td>
                    <td class="px-6 py-4">${d.type}</td>
                    <td class="px-6 py-4 text-gray-500">${d.date}</td>
                    <td class="px-6 py-4"><span class="status-badge status-active">Uploaded</span></td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-blue-600 hover:text-blue-800 text-sm">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderAuditDocs(docs) {
            const container = document.getElementById('audit-docs-body');
            const emptyState = document.getElementById('audit-empty-state');
            if(!container) return;

            if(docs.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                container.innerHTML = '';
                return;
            } else {
                if(emptyState) emptyState.classList.add('hidden');
            }

            container.innerHTML = docs.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800">${d.name}</td>
                    <td class="px-6 py-4">${d.date}</td>
                    <td class="px-6 py-4"><span class="status-badge status-active">Uploaded</span></td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-blue-600 hover:text-blue-800 text-sm">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderVehicleLogs(logs) {
            const container = document.getElementById('vehicle-logs-body');
            const emptyState = document.getElementById('vehicle-empty-state');
            if(!container) return;

            if(logs.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                container.innerHTML = '';
                return;
            } else {
                if(emptyState) emptyState.classList.add('hidden');
            }

            container.innerHTML = logs.map(l => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-800">${l.vehicle}</td>
                    <td class="px-6 py-4">${l.driver}</td>
                    <td class="px-6 py-4">${l.type}</td>
                    <td class="px-6 py-4">${l.date}</td>
                    <td class="px-6 py-4">${l.details}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        // Initialize Render
        renderAll();

        // Export functions to global scope for HTML event attributes (onclick)
        window.switchTab = function(tabName) {
            const tabs = ['dashboard', 'licenses', 'permits', 'techs', 'osha', 'insurance', 'audit', 'vehicle_logs'];
            tabs.forEach(t => {
                const tabEl = document.getElementById('tab-' + t);
                const navEl = document.getElementById('nav-' + t);
                if(tabEl) tabEl.classList.add('hidden');
                if(navEl) navEl.classList.remove('active');
                
                const icon = document.querySelector('#nav-' + t + ' i');
                if(icon) icon.classList.replace('text-blue-400', 'text-gray-400');
            });
            
            const activeTab = document.getElementById('tab-' + tabName);
            const activeNav = document.getElementById('nav-' + tabName);
            
            if(activeTab) activeTab.classList.remove('hidden');
            if(activeNav) activeNav.classList.add('active');
            
            const activeIcon = document.querySelector('#nav-' + tabName + ' i');
            if(activeIcon) activeIcon.classList.replace('text-gray-400', 'text-blue-400');
            
            const titles = { 
                'dashboard': 'Compliance Dashboard', 
                'licenses': 'City Registrations', 
                'permits': 'Permits & Tracking',
                'techs': 'Technician Certifications', 
                'osha': 'Safety & OSHA', 
                'insurance': 'Insurance Policies',
                'audit': 'Annual Insurance Audits',
                'vehicle_logs': 'Vehicle Logs & Maintenance'
            };
            document.getElementById('page-title').innerText = titles[tabName] || 'Dashboard';
        };

        window.toggleModal = function(modalID) {
            const modal = document.getElementById(modalID);
            if(modal) {
                modal.classList.toggle('opacity-0');
                modal.classList.toggle('pointer-events-none');
                document.body.classList.toggle('modal-active');
            }
        };

        window.managePermit = function(number, address) {
            // Pre-fill modal for editing/managing
            document.getElementById('input-record-type').value = 'permit';
            document.getElementById('input-details').value = address + ' (' + number + ')';
            window.toggleModal('uploadModal');
        };

        window.saveRecord = async function() {
            const btn = document.querySelector('#uploadModal button.bg-blue-600');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            
            const type = document.getElementById('input-record-type').value;
            const details = document.getElementById('input-details').value || "Unnamed Record";
            const date = document.getElementById('input-expiration').value || new Date().toISOString().split('T')[0];
            
            // 1. ATTEMPT FIRESTORE WRITE IF LOGGED IN
            if (auth.currentUser) {
                try {
                    // Always log activity
                    await addDoc(collection(db, "activity"), {
                        type: type,
                        details: details,
                        date: date,
                        userEmail: auth.currentUser.email,
                        timestamp: new Date()
                    });

                    // Save to specific collection
                    let targetCollection = null;
                    let docData = {
                        created_at: new Date(),
                        user_id: auth.currentUser.uid,
                        details: details,
                        date: date
                    };

                    if (type === 'license') {
                        targetCollection = "licenses";
                        Object.assign(docData, { name: details, number: "PENDING", expires: date, status: "Active", issuer: "City Dept" });
                    } else if (type === 'permit') {
                        targetCollection = "permits";
                        Object.assign(docData, { address: details, municipality: "Detroit", number: "P-NEW", type: "Mechanical", status: "Applied", fees: "150.00" });
                    } else if (type === 'vehicle_inspection') {
                        targetCollection = "vehicle_logs";
                        Object.assign(docData, { vehicle: details.split(',')[0], driver: "Current User", type: "Inspection", details: details });
                    } else if (type === 'audit_doc') {
                        targetCollection = "audit_docs";
                        Object.assign(docData, { name: details });
                    } else if (type.includes('inspection') || type.includes('driver')) {
                        targetCollection = "safety_docs";
                        Object.assign(docData, { name: details, type: type.replace('_', ' ') });
                    }

                    if(targetCollection) {
                        await addDoc(collection(db, targetCollection), docData);
                    }
                    
                    alert('Saved to Database!');
                    
                    // RE-FETCH to show updates immediately from server
                    await fetchData();

                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert('Error saving to Cloud. Check console.');
                }
            } else {
                 alert('Saved LOCALLY (Not logged in to Firebase)');
            }

            // Reset UI
            btn.innerText = originalText;
            window.toggleModal('uploadModal');
        };

        // Add fade animation style dynamically
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fade {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade {
                animation: fade 0.3s ease-out forwards;
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
